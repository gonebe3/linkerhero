2025-08-19 – Google/LinkedIn OAuth, quotas, email confirmation, and UI fixes

Summary of changes

- OAuth & auth flows
  - Implemented Google OAuth: `/oauth/google/start` and `/auth/google/callback`, using `GOOGLE_CLIENT_ID`, `GOOGLE_CLIENT_SECRET`, `GOOGLE_SCOPES`.
  - Hardened LinkedIn OAuth by building `redirect_uri` from `APP_BASE_URL` to avoid localhost/127.0.0.1 mismatches.
  - Added `display_name` to `users` and populate from OAuth `given_name` or email prefix; created corrective migration to add the column.
  - Set `email_verified_at` for OAuth sign-ins; added email confirmation for email/password and magic-link flows.
  - New routes: `/confirm` (verify token) and `/confirm/resend` (send confirmation).
  - Removed “Login with magic link” option from UI (email/password + LinkedIn + Google only).

- DB and reliability
  - Added robust SQLAlchemy engine options to reduce Neon SSL disconnects (`pool_pre_ping`, `pool_recycle`, sizing via env).
  - Fixed session creation NOT NULL issue by flushing after creating `User` before inserting `Session`.

- Quotas & renewal
  - Monthly quotas: set `plan_started_at`/`plan_renews_at` on signup; reset quota usage when due.
  - Auto-renew runs in `before_request` so it’s not tied to visiting the dashboard.
  - Dashboard shows compact “Generations left” chip and “Renews on: {date}”.

- Generation & dashboard UX
  - Dashboard: moved chips to the right, added “Welcome back, {Name}”, removed duplicate navbar Dashboard, fixed button placement under expanded generations, added delete route (`/me/generations/<id>/delete`).
  - Count now reflects actual saved generations, quotas increment on generate.
  - Generation page: auto-scroll to results, reduced spacing.

- Registration & login pages
  - Registration form: improved autofill behavior (no auto-expand on social click), disabled autocomplete, and added social buttons that don’t trigger form JS.
  - “Check your email” page: spacing/alignment fixed; renamed to “Confirm your email address”.

- Layout
  - Added global footer partial and removed duplicate local footers from Home/Pricing.

- Dev ergonomics
  - Added `run.py` launcher.

Environment

- `.env` keys used:
  - `APP_BASE_URL`, `FLASK_ENV`, `SECRET_KEY`
  - DB: `DATABASE_URL` (pooled), `DATABASE_URL_DIRECT` (direct)
  - Email: `MAIL_FROM`, `SMTP_HOST`, `SMTP_PORT`, `SMTP_USER`, `SMTP_PASS`
  - OAuth: `LINKEDIN_CLIENT_ID`, `LINKEDIN_CLIENT_SECRET`, `LINKEDIN_SCOPES`, `GOOGLE_CLIENT_ID`, `GOOGLE_CLIENT_SECRET`, `GOOGLE_SCOPES`
  - Optional DB pool tuning: `DB_POOL_RECYCLE`, `DB_POOL_SIZE`, `DB_MAX_OVERFLOW`, `DB_POOL_TIMEOUT`

Follow-ups

- Optionally enrich `display_name` for existing users or add a profile editing form.
- Wire up Google branding and production redirect URIs; publish OAuth app when moving out of test mode.

Troubleshooting: LinkedIn Share

- Offsite Share dialog (composer) accepts only a public, fetchable URL; it cannot prefill arbitrary text.
  - We expose a read-only preview at `/share/preview/<gen_id>` and pass that URL to `https://www.linkedin.com/sharing/share-offsite/?url=...`.
  - On localhost, LinkedIn’s servers cannot reach your machine; composer shows "Cannot display preview" and appears blank. This is expected.
  - To test preview locally: run behind a public HTTPS tunnel (e.g., ngrok), set `APP_BASE_URL` to the tunnel URL, restart, then the composer should render a link preview and allow editing the caption.
- One-click API posting via UGC (w_member_social) can publish without an edit UI; we disabled implicit account switching during share flows. Current UX prefers the offsite composer so users can edit on LinkedIn.


