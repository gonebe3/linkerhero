# Dev log — 2025-08-12

## What we fixed/finished today

- Alembic/DB
  - Resolved bad Alembic revision (`e1f2a3b4c5d6`) by stamping the remote Postgres to valid heads.
  - Handled duplicate table errors by stamping to the correct later revision, then upgrading to head (`c3afb846b1ba`).
  - Added `flask db stamp` to our CLI.

- RSS/News
  - Ingestion now only stores items with an explicit image URL.
  - Listing (`/news`) shows only articles with `image_url` (filters out imageless items).
  - Added CLI `rss:purge_no_image` to soft‑delete old imageless articles.

- Generate MVP (new flow)
  - New page (`/generate`) (previously `/generate_v2`) with strict mutual exclusivity: URL or Text (not both).
  - Prefill URL when navigating from News → Generate.
  - Scraping pipeline uses async httpx + trafilatura fallback; truncates combined content to 8,000 chars for prompting.
  - Providers accept persona, tone, hook_type, and keywords; removed scoring for MVP.
  - Model picker added: Claude 3.5 Sonnet vs ChatGPT 5; request chooses provider.
  - UI: dark, rounded custom dropdowns; improved form UX.
  - Server-side validation via Flask‑WTF `GenerateForm` (enforces exclusivity and URL validation).
  - `/generate_v2` now redirects to `/generate` (canonical path).
  - Enabled `TEMPLATES_AUTO_RELOAD=True`.

### Later updates (same day)

- Generate button end-to-end now working (HTMX form)
  - Disabled CSRF for this endpoint via `GenerateForm.Meta.csrf = False`.
  - Single draft output (not 3) with longer content (max_tokens 600) and explicit structure: hook + 2–4 short paragraphs + light CTA.
  - Providers updated to return only the post text (strip "Here is..." prefaces) and to respect structure; single-variant path returns full text.
  - Results view renders multi-paragraph text by converting newlines to `<br/>`.
  - Model picker active (Claude 3.5 Sonnet or GPT‑5).
  - Anonymous users can generate (no save); logged-in users persist to `generations`.

- CI
  - Simplified GitHub Actions workflow to run tests only (removed lint/type check for now).

## Important context issues discovered

- Windows path/casing caused confusion: app sometimes referenced `C:\Users\domin\linkerhero\...` while we edited `C:\Users\domin\LinkerHero\...`. Using `/generate` as canonical avoids stale template issues.

## Next up (implementation plan)

1) Prompt quality
   - Finalize a single prompt template shared by providers that consistently applies: persona, tone, hook_type, keywords, and max paragraph length. Add concise CTA guidance.
   - Add per-provider model names in config; surface in UI if needed.

2) Scraping hardening
   - Add SSRF protections (block private/metadata IPs, require https, size/time limits).
   - Cache scrape results per URL for short TTL to reduce latency.

3) Quotas and rate limiting
   - Enforce per-plan monthly quotas (already in models) and per-minute rate limits.
   - Return friendly errors and expose remaining quota in UI.

4) Tokens/telemetry
   - Track tokens_used (if provider returns usage) and latency per request.
   - Basic audit log: user_id, model, source (url/text), duration.

5) UX polish
   - Convert Persona dropdown to custom component (done), ensure keyboard navigation.
   - Better error banners in results if validation/scrape/provider fails.

6) Tests
   - Unit tests: exclusivity validation, prompt assembly with each hook_type, scraping truncate logic.
   - Integration: `/api/generate` for url-only, text-only, both/none; provider mocked.

7) Cleanup
  - Verified: `/generate` serves the new UI; `/generate_v2` redirects to `/generate`.
   - Remove legacy assets that referenced “Select Recent Article”.

## Commands

- Show current routes:
  - `python -m flask --app app routes`
- Refresh feeds (image-only):
  - `python -m flask --app app rss:refresh`
- Purge imageless articles:
  - `python -m flask --app app rss:purge_no_image`


