{% extends 'base_spaceship.html' %}
{% block content %}
<div class="container pt-6rem">
  <div class="section maxw-560 mx-auto">
    <div class="card p-1">
      <h2 class="c-white mb-0">Checkout</h2>
      <p class="c-muted">Personal plan â€” $8.99 / month</p>
      <div id="stripe-debug" class="hidden c-error mb-2"></div>
      <div id="card-number-element" class="form-input stripe-element"></div>
      <div class="flex gap-05 mt-05">
        <div id="card-expiry-element" class="form-input stripe-element flex-1"></div>
        <div id="card-cvc-element" class="form-input stripe-element flex-1"></div>
      </div>
      <div id="stripe-error" class="hidden c-error mt-05"></div>
      <button id="stripe-pay" class="btn w-full mt-4">Pay $8.99</button>
    </div>
  </div>
</div>
<script>
// Minimal mount for Stripe Elements on checkout page using provided pk
document.addEventListener('DOMContentLoaded', async function () {
  const debug = document.getElementById('stripe-debug');
  function show(msg) { if (debug) { debug.style.display='block'; debug.textContent = msg; } }
  try {
    const pk = {{ stripe_pk and ('"' ~ stripe_pk ~ '"') or 'null' }};
    if (!pk) { show('Stripe publishable key missing'); return; }
    if (!window.Stripe) {
      await new Promise((resolve, reject) => {
        const s = document.createElement('script'); s.src = 'https://js.stripe.com/v3'; s.onload = resolve; s.onerror = reject; document.head.appendChild(s);
      });
    }
    const stripe = window.Stripe(pk);
    const elements = stripe.elements();
    const style = { base: { fontSize: '16px', color: '#fff', '::placeholder': { color: '#999' } } };
    const cardNumber = elements.create('cardNumber', { style });
    const cardExpiry = elements.create('cardExpiry', { style });
    const cardCvc = elements.create('cardCvc', { style });
    cardNumber.mount('#card-number-element');
    cardExpiry.mount('#card-expiry-element');
    cardCvc.mount('#card-cvc-element');
    const errorBox = document.getElementById('stripe-error');
    cardNumber.on('change', function(event) { if (event.error) { errorBox.textContent = event.error.message; errorBox.style.display='block'; } else { errorBox.style.display='none'; } });
    // Create intent right away
    const resp = await fetch('/billing/create-payment-intent', { method:'POST', headers:{'Content-Type':'application/json','X-CSRFToken': (window.__CSRF_TOKEN__||'')}, body: JSON.stringify({ amount_cents: {{ amount_cents }}, currency: '{{ currency }}' }) });
    const data = await resp.json();
    if (!data.clientSecret) { show('Could not create PaymentIntent'); return; }
    const payBtn = document.getElementById('stripe-pay');
    payBtn.onclick = async () => {
      payBtn.disabled = true;
      const { error, paymentIntent } = await stripe.confirmCardPayment(data.clientSecret, { payment_method: { card: cardNumber } });
      if (error) { errorBox.textContent = error.message || 'Payment failed'; errorBox.style.display='block'; payBtn.disabled=false; return; }
      if (paymentIntent && paymentIntent.status === 'succeeded') {
        await fetch('/billing/success', { method:'POST', headers:{'Content-Type':'application/json','X-CSRFToken': (window.__CSRF_TOKEN__||'')}, body: JSON.stringify({ payment_intent_id: paymentIntent.id }) });
        window.location.href = '/me/dashboard';
      }
    };
  } catch (e) { show('Stripe init error: ' + (e.message || e)); }
});
</script>
{% endblock %}

