{% extends 'base_spaceship.html' %}
{% block content %}
<div class="container" style="padding-top:6rem;">
  <div class="section" style="max-width: 560px; margin: 0 auto;">
    <div class="card" style="padding:1rem;">
      <h2 style="color:#fff; margin-top:0;">Checkout</h2>
      <p style="color:#bbb;">Personal plan â€” $8.99 / month</p>
      <div id="stripe-debug" style="display:none; color:#fca5a5; margin-bottom:0.5rem;"></div>
      <div id="card-number-element" class="form-input" style="padding: 12px; background: rgba(255,255,255,0.06); border:1px solid rgba(255,255,255,0.12); border-radius:8px;"></div>
      <div style="display:flex; gap:0.5rem; margin-top:0.5rem;">
        <div id="card-expiry-element" class="form-input" style="flex:1; padding: 12px; background: rgba(255,255,255,0.06); border:1px solid rgba(255,255,255,0.12); border-radius:8px;"></div>
        <div id="card-cvc-element" class="form-input" style="flex:1; padding: 12px; background: rgba(255,255,255,0.06); border:1px solid rgba(255,255,255,0.12); border-radius:8px;"></div>
      </div>
      <div id="stripe-error" style="display:none; color:#fca5a5; margin-top:0.5rem;"></div>
      <button id="stripe-pay" class="btn" style="margin-top:1rem; width:100%;">Pay $8.99</button>
    </div>
  </div>
</div>
<script>
// Minimal mount for Stripe Elements on checkout page using provided pk
document.addEventListener('DOMContentLoaded', async function () {
  const debug = document.getElementById('stripe-debug');
  function show(msg) { if (debug) { debug.style.display='block'; debug.textContent = msg; } }
  try {
    const pk = {{ stripe_pk and ('"' ~ stripe_pk ~ '"') or 'null' }};
    if (!pk) { show('Stripe publishable key missing'); return; }
    if (!window.Stripe) {
      await new Promise((resolve, reject) => {
        const s = document.createElement('script'); s.src = 'https://js.stripe.com/v3'; s.onload = resolve; s.onerror = reject; document.head.appendChild(s);
      });
    }
    const stripe = window.Stripe(pk);
    const elements = stripe.elements();
    const style = { base: { fontSize: '16px', color: '#fff', '::placeholder': { color: '#999' } } };
    const cardNumber = elements.create('cardNumber', { style });
    const cardExpiry = elements.create('cardExpiry', { style });
    const cardCvc = elements.create('cardCvc', { style });
    cardNumber.mount('#card-number-element');
    cardExpiry.mount('#card-expiry-element');
    cardCvc.mount('#card-cvc-element');
    const errorBox = document.getElementById('stripe-error');
    cardNumber.on('change', function(event) { if (event.error) { errorBox.textContent = event.error.message; errorBox.style.display='block'; } else { errorBox.style.display='none'; } });
    // Create intent right away
    const resp = await fetch('/billing/create-payment-intent', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ amount_cents: {{ amount_cents }}, currency: '{{ currency }}' }) });
    const data = await resp.json();
    if (!data.clientSecret) { show('Could not create PaymentIntent'); return; }
    const payBtn = document.getElementById('stripe-pay');
    payBtn.onclick = async () => {
      payBtn.disabled = true;
      const { error, paymentIntent } = await stripe.confirmCardPayment(data.clientSecret, { payment_method: { card: cardNumber } });
      if (error) { errorBox.textContent = error.message || 'Payment failed'; errorBox.style.display='block'; payBtn.disabled=false; return; }
      if (paymentIntent && paymentIntent.status === 'succeeded') {
        await fetch('/billing/success', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ payment_intent_id: paymentIntent.id }) });
        window.location.href = '/me/dashboard';
      }
    };
  } catch (e) { show('Stripe init error: ' + (e.message || e)); }
});
</script>
{% endblock %}

