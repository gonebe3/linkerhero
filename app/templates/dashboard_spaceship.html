{% extends 'base_spaceship.html' %}
{% block content %}
<div class="container pt-6rem">
  <div class="section flex justify-between items-center gap-1 flex-wrap">
    <div class="flex-auto minw-260">
      <p class="c-white fw-600 fs-175rem m-0">Welcome back, {{ user_display_name(user) }}</p>
    </div>
    <!-- Unified Plan module -->
    <div class="card flex-b-560 c-white p-0625 bg-card border-card">
      <!-- Header: plan + status -->
      <div class="flex items-center justify-between gap-075 flex-wrap">
        <div class="flex items-center gap-05 fw-600">Plan: <span>{{ user.plan|title }}</span>
          {% if user and user.plan != 'free' and user.cancel_at_period_end %}
            <span class="chip chip-warning ml-025 fs-09rem">Ends on {{ user.plan_renews_at and user.plan_renews_at.strftime('%Y-%m-%d') }}</span>
          {% endif %}
        </div>
        <div class="flex gap-05">
          {% if user.plan == 'free' %}
            <a href="/pricing" class="btn btn-cta minw-160">Upgrade to Personal</a>
          {% else %}
            <a href="/billing/portal" class="btn btn-cta minw-180" target="_blank" rel="noopener">Manage Subscription</a>
          {% endif %}
        </div>
      </div>
      <!-- Chips: left + renew -->
      <div class="flex gap-05 flex-wrap items-center justify-between mt-075rem">
        <span class="chip chip-success">Generations left: <strong>{{ left_total }}</strong></span>
        <span class="flex-auto"></span>
        {% if user and user.plan_renews_at and not user.cancel_at_period_end %}
        <span class="chip chip-info">Renews: <strong>{{ user.plan_renews_at.strftime('%Y-%m-%d') }}</strong></span>
        {% endif %}
      </div>
    </div>
  </div>

  {# No extra banner; state is integrated into the Plan module #}

  <div class="section">
    <h3 class="c-white fw-700 fs-125rem mb-3">Your Generations{% if generations_count is not none %} ({{ generations_count }}){% endif %}</h3>
    <div class="card p-05">
      {% if generations %}
      <div class="list">
        {% for g in generations %}
        <details class="list-item bg-soft border-soft rounded-12 p-075">
          <summary class="cursor-pointer c-white outline-none list-none">
            {% set first_line = (g.draft_text.split('\n')[0] if g.draft_text else '') %}
            <span class="opacity-85">{{ first_line[:120] }}{% if first_line|length > 120 %}...{% endif %}</span>
            <span class="opacity-50 ml-05">â€¢ {{ g.created_at.strftime('%Y-%m-%d %H:%M') }}</span>
          </summary>
          <pre class="pre-wrap color-muted font-inherit mb-05">{{ (g.draft_text.split('\n', 1)[1] if ('\n' in g.draft_text) else g.draft_text) }}</pre>
          <pre class="full-text hidden">{{ g.draft_text }}</pre>
          <div class="flex gap-05 justify-end mt-025">
            <button class="btn" onclick="(function(btn){var d=btn.closest('details');var full=d&&d.querySelector('.full-text'); if(full){navigator.clipboard.writeText(full.textContent).then(()=>showNotification('Copied to clipboard'));}})(this)">Copy</button>
            <a class="btn" href="https://www.linkedin.com/sharing/share-offsite/?url={{ absolute_url('share/preview/' ~ g.id) }}" target="_blank" rel="noopener">Share on LinkedIn</a>
            <form method="post" action="/me/generations/{{ g.id }}/delete" onsubmit="return confirm('Delete this generation?')">
              <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
              <button type="submit" class="btn btn-danger">Delete</button>
            </form>
          </div>
        </details>
        {% endfor %}
      </div>
      {% else %}
      <div class="text-center c-muted">No generations yet.</div>
      {% endif %}
    </div>
  </div>
  {# Removed local cancel/resume modals in favor of Stripe Customer Portal management #}

</div>
{% endblock %}


