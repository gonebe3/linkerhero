{% extends 'base_spaceship.html' %}
{% set body_class = 'page-generate' %}
{% block content %}
{% from 'partials/generation_icons.html' import gen_icon %}
{% set mode = (prefill_url and 'url') or 'text' %}

<div class="container pt-6rem gen-page">
  <div class="gen-hero text-center">
    <h1 class="gen-hero__title">
      <span class="gen-hero__line1">
        <span class="gen-hero__static">Generate</span>
        <span class="gen-hero__typed" id="gen-typed-word">Per</span><span class="gen-hero__cursor" aria-hidden="true">_</span>
      </span>
      <span class="gen-hero__line2">LinkedIn Posts Drafts &amp; Visuals</span>
    </h1>
  </div>

  <form
    id="gen-form"
    class="gen-form"
    action="/api/generate"
    method="post"
    hx-post="/api/generate"
    hx-target="#results"
    hx-swap="innerHTML"
    hx-indicator="#loading"
    autocomplete="off"
    enctype="multipart/form-data"
    hx-encoding="multipart/form-data"
    hx-on::after-settle="document.getElementById('results') && document.getElementById('results').scrollIntoView({behavior:'smooth', block:'start'});"
  >
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
    <input type="hidden" name="source_mode" id="source_mode" value="{{ mode }}" />

    {# Defaults for accordion settings #}
    <input type="hidden" name="hook_type" id="field-hook_type" value="auto" />
    <input type="hidden" name="persona" id="field-persona" value="auto" />
    <input type="hidden" name="tone" id="field-tone" value="auto" />
    <input type="hidden" name="goal" id="field-goal" value="auto" />
    <input type="hidden" name="length" id="field-length" value="auto" />
    <input type="hidden" name="ending" id="field-ending" value="auto" />

    {# Footer settings #}
    <input type="hidden" name="emoji" id="field-emoji" value="no" />
    <input type="hidden" name="language" id="field-language" value="English" />
    <input type="hidden" name="model" id="field-model" value="claude-sonnet-4-5" />
    <input type="hidden" id="gen-fallback-logo" value="{{ url_for('static', filename='images/logos/default.svg') }}" />

    <div class="section gen-section">
      <div class="gen-grid">
        <div class="gen-block gen-block--source">
          <div class="gen-block__header">
            <div class="gen-block__title">Source</div>
            <div class="gen-block__subtitle">Choose your source and optional prompt</div>
          </div>

          <div class="gen-source-top">
            <div class="gen-segmented" id="source-switch" role="tablist" aria-label="Input source">
              <button type="button" class="gen-segmented__btn" data-mode="text" role="tab" aria-selected="false">Text</button>
              <button type="button" class="gen-segmented__btn" data-mode="url" role="tab" aria-selected="false">URL</button>
              <button type="button" class="gen-segmented__btn" data-mode="file" role="tab" aria-selected="false">File</button>
            </div>
            <div class="gen-source-top__hint">
              Ready to be inspired? Find shareable stories in our
              <a class="gen-link" href="/news">Content Fuel</a> feedðŸŒŸ
            </div>
          </div>

          <div class="gen-source-block {% if mode != 'url' %}hidden{% endif %}" id="block-url">
            <label class="gen-label" for="url_input">Article URL</label>
            <input id="url_input" type="url" name="url" value="{{ prefill_url or form.url.data or '' }}" class="gen-input" placeholder="Insert article URL" />
            <div class="gen-hint">Paste a single public URL. We'll fetch the content.</div>
          </div>

          <div class="gen-source-block {% if mode != 'file' %}hidden{% endif %}" id="block-file">
            <label class="gen-label">Upload File</label>
            <div id="dropzone" class="gen-dropzone" role="button" tabindex="0" aria-label="Upload file by clicking or dragging">
              <input type="file" name="file" id="file_input" hidden accept=".txt,.pdf,.docx" />
              <div class="gen-dropzone__content">
                <div class="gen-dropzone__icon">ðŸ“„</div>
                <div class="gen-dropzone__text">
                  <strong>Drag &amp; drop a file</strong> or <span class="gen-dropzone__link">click to choose</span>
                  <div class="gen-dropzone__hint">Up to 50 MB. Supported: .txt, .pdf, .docx</div>
                </div>
              </div>
              <div class="gen-dropzone__preview hidden" id="file_preview"></div>
            </div>
          </div>

          <div class="gen-source-block {% if mode == 'text' %}{% else %}{% endif %}" id="block-text">
            <label class="gen-label" for="text_input">Write/Paste Text</label>
            <textarea id="text_input" name="text" rows="6" class="gen-textarea" placeholder="Insert your text here">{{ form.text.data or '' }}</textarea>
          </div>

          {# Prompt box removed (per UX decision) #}
        </div>

        <div class="gen-block gen-block--settings">
          <div class="gen-block__header">
            <div class="gen-block__title">Settings</div>
            <div class="gen-block__subtitle">Pick a category, then choose a visual card</div>
          </div>

          <div class="gen-accordion" data-accordion-root>
            {% for cat in generation_categories %}
              {% if cat.id == 'goal' %}
                <hr class="gen-separator" />
              {% endif %}

              {% set panel_id = 'panel-' ~ cat.id %}
              {% set btn_id = 'btn-' ~ cat.id %}
              <div class="gen-accordion__item" data-accordion-item data-category-id="{{ cat.id }}">
                <button
                  type="button"
                  class="gen-accordion__btn"
                  id="{{ btn_id }}"
                  aria-expanded="false"
                  aria-controls="{{ panel_id }}"
                  data-accordion-button
                >
                  <span class="gen-accordion__icon">
                    {{ gen_icon(cat.id) }}
                  </span>
                  <span class="gen-accordion__label">{{ cat.name }}</span>
                  <span class="gen-accordion__value" data-accordion-value="{{ cat.id }}">Option: Auto</span>
                  <span class="gen-accordion__chevron" aria-hidden="true">â–¾</span>
                </button>

                <div class="gen-accordion__panel hidden" id="{{ panel_id }}" role="region" aria-labelledby="{{ btn_id }}" data-accordion-panel>
                  <div class="gen-panel-loading hidden" data-panel-loading aria-live="polite" aria-label="Loading">
                    <div class="spinner gen-panel-loading__spinner" aria-hidden="true"></div>
                  </div>
                  <div class="gen-cards" role="list" data-cards-grid>
                    {% for opt in cat.options %}
                      <button
                        type="button"
                        class="gen-card"
                        data-category="{{ cat.id }}"
                        data-option="{{ opt.id }}"
                        role="listitem"
                        aria-pressed="false"
                      >
                        <span class="gen-card__bg">
                          <img
                            class="gen-card__img"
                            src="{{ url_for('static', filename=opt.image_filename) }}"
                            alt=""
                            loading="lazy"
                            width="140"
                            height="210"
                          />
                        </span>
                        <span class="gen-card__overlay"></span>
                        <span class="gen-card__text">
                          <span class="gen-card__name">{{ opt.name }}</span>
                          <span class="gen-card__desc">{{ opt.description }}</span>
                        </span>
                      </button>
                    {% endfor %}
                  </div>
                </div>
              </div>
            {% endfor %}
          </div>

          <div class="gen-footer-settings">
            <div class="gen-footer-settings__row gen-footer-settings__row--controls">
              <div class="gen-footer-settings__group">
                <div class="gen-footer-settings__label">Emoji</div>
                <div class="gen-toggle" data-toggle="emoji">
                  <button type="button" class="gen-toggle__btn is-active" data-value="no" aria-pressed="true">No</button>
                  <button type="button" class="gen-toggle__btn" data-value="yes" aria-pressed="false">Yes</button>
                </div>
              </div>
              <div class="gen-footer-settings__group">
                <div class="gen-footer-settings__label">Model</div>
                <div class="gen-toggle" data-toggle="model">
                  <button type="button" class="gen-toggle__btn is-active" data-value="claude-sonnet-4-5" aria-pressed="true">Claude Sonnet 4.5</button>
                  <button type="button" class="gen-toggle__btn" data-value="chatgpt-5-2" aria-pressed="false">ChatGPT 5.2</button>
                </div>
              </div>
              <div class="gen-footer-settings__group">
                <label class="gen-footer-settings__label" for="language_select">Language</label>
                <select id="language_select" class="gen-select gen-select--compact" name="language_select" aria-label="Language">
                  {% for lang in ['English','Spanish','French','German','Portuguese','Italian','Dutch','Japanese','Korean','Chinese'] %}
                    <option value="{{ lang }}" {% if lang == 'English' %}selected{% endif %}>{{ lang }}</option>
                  {% endfor %}
                </select>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="text-center mt-4">
        <button type="submit" class="btn btn-cta py-12rem px-3rem fs-12rem">
          âœ¨ Generate Posts
        </button>
      </div>
    </div>
  </form>

  <div id="loading" class="htmx-indicator text-center mt-3">
    <div class="card">
      <div class="spinner my-2rem mx-auto"></div>
      <p class="c-white fs-11rem">ðŸš€ AI is crafting your posts...</p>
    </div>
  </div>

  <div id="results" class="mt-3"></div>
</div>

<!-- Client-side extractors -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.5.136/pdf.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script src="{{ url_for('static', filename='js/generation_page.js') }}"></script>
{% endblock %}
