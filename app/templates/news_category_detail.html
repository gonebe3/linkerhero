{% extends 'base_spaceship.html' %}
{% block content %}
<div class="container pt-6rem">
  <div class="section">
    <!-- Header with back link -->
    <div class="mb-3">
      <a href="/news" class="c-white-60 hover-c-white text-decoration-none mb-1 inline-block">
        ‚Üê Back to Categories
      </a>
      <h1 class="fs-2rem fw-800 mb-05 c-white">{{ category.name }}</h1>
      <p class="c-white-60">{{ total_count }} article{{ 's' if total_count != 1 else '' }} available</p>
    </div>
    
    <!-- Most Generated Section (only shows if users have generated from articles) -->
    {% if most_generated_articles %}
    <div class="trending-section">
      <div class="trending-section__header">
        <span class="trending-section__icon">‚≠ê</span>
        <h2 class="trending-section__title">Most Popular</h2>
        <span class="fs-09rem c-white-60 ml-1">(Generated {{ most_generated_articles[0].generation_count }}+ times)</span>
      </div>
      <div class="flex gap-1 flex-wrap">
        {% for article in most_generated_articles %}
        <a href="/generate?url={{ article.url|urlencode }}" class="btn btn-secondary" style="flex: 1 1 auto; min-width: 200px; text-align: left; padding: 12px 16px;">
          <div class="fs-09rem fw-600 c-white mb-025">{{ article.title|truncate(60) }}</div>
          <div class="fs-075rem c-white-60">{{ article.source_name or 'Unknown Source' }} ‚Ä¢ Generated {{ article.generation_count }}x</div>
        </a>
        {% endfor %}
      </div>
    </div>
    {% endif %}
    
    <!-- Two-column layout: Main content + Sidebar -->
    <div class="content-with-sidebar">
      <!-- Sidebar with sources (LEFT SIDE) -->
      {% if sources %}
      <div class="sidebar">
        <div class="card">
          <h3 class="c-white fw-700 fs-1rem mb-2">Filter by Source</h3>
          <div class="source-list-vertical">
            <a 
              href="/news/{{ category.slug }}?filter={{ current_filter }}{% if query %}&q={{ query|urlencode }}{% endif %}" 
              class="source-list-item {% if not current_source %}source-list-item-active{% endif %}"
            >
              <span class="source-list-name">All Sources</span>
              <span class="source-list-count">{{ source_type_counts.free + source_type_counts.freemium + source_type_counts.paid }}</span>
            </a>
            {% for src in sources %}
            <a 
              href="/news/{{ category.slug }}?source={{ src.name|urlencode }}&filter={{ current_filter }}{% if query %}&q={{ query|urlencode }}{% endif %}" 
              class="source-list-item {% if current_source == src.name %}source-list-item-active{% endif %}"
            >
              <span class="source-list-name">
                {{ src.name }}
                {% if src.source_type == 'free' %}<span class="source-type-badge source-type-badge-free">Free</span>{% endif %}
                {% if src.source_type == 'freemium' %}<span class="source-type-badge source-type-badge-limited">Limited</span>{% endif %}
                {% if src.source_type == 'paid' %}<span class="source-type-badge source-type-badge-paid">Paid</span>{% endif %}
              </span>
              <span class="source-list-count">{{ src.count }}</span>
            </a>
            {% endfor %}
          </div>
        </div>
      </div>
      {% endif %}
      
      <!-- Main content area -->
      <div class="main-content">
        <!-- Beautiful info banner -->
        <div class="info-banner-modern mb-3">
          <div class="info-banner-icon-wrap">
            <span class="info-banner-icon">‚ú®</span>
          </div>
          <div class="info-banner-body">
            <div class="info-banner-title">How it works</div>
            <div class="info-banner-text">Posts are generated from article headlines and summaries. For best results, read the full article and add your own insights!</div>
          </div>
        </div>
        
        <!-- Source type filter toggle -->
        <div class="filter-toggle mb-3">
          <div class="filter-toggle-inner">
            <a 
              href="/news/{{ category.slug }}?filter=all{% if query %}&q={{ query|urlencode }}{% endif %}{% if current_source %}&source={{ current_source|urlencode }}{% endif %}" 
              class="filter-btn {% if current_filter == 'all' %}filter-btn-active{% endif %}"
            >
              üì∞ All
              <span class="filter-count">{{ source_type_counts.free + source_type_counts.freemium + source_type_counts.paid }}</span>
            </a>
            <a 
              href="/news/{{ category.slug }}?filter=free{% if query %}&q={{ query|urlencode }}{% endif %}{% if current_source %}&source={{ current_source|urlencode }}{% endif %}" 
              class="filter-btn filter-btn-free {% if current_filter == 'free' %}filter-btn-active{% endif %}"
            >
              ‚úÖ Free
              <span class="filter-count">{{ source_type_counts.free }}</span>
            </a>
            {% if source_type_counts.freemium > 0 %}
            <a 
              href="/news/{{ category.slug }}?filter=freemium{% if query %}&q={{ query|urlencode }}{% endif %}{% if current_source %}&source={{ current_source|urlencode }}{% endif %}" 
              class="filter-btn filter-btn-limited {% if current_filter == 'freemium' %}filter-btn-active{% endif %}"
            >
              ‚ö° Limited
              <span class="filter-count">{{ source_type_counts.freemium }}</span>
            </a>
            {% endif %}
            {% if source_type_counts.paid > 0 %}
            <a 
              href="/news/{{ category.slug }}?filter=paid{% if query %}&q={{ query|urlencode }}{% endif %}{% if current_source %}&source={{ current_source|urlencode }}{% endif %}" 
              class="filter-btn filter-btn-paid {% if current_filter == 'paid' %}filter-btn-active{% endif %}"
            >
              üîí Paid
              <span class="filter-count">{{ source_type_counts.paid }}</span>
            </a>
            {% endif %}
            <!-- Info icon with explanation tooltip -->
            <div class="source-info-trigger">
              <span class="source-info-icon">‚ÑπÔ∏è</span>
              <div class="source-info-popup">
                <div class="source-info-title">About Article Sources</div>
                <div class="source-info-desc">These labels refer to the <strong>original publisher's</strong> access policy, not LinkerHero:</div>
                <div class="source-info-item">
                  <span class="source-info-badge source-info-badge-free">‚úÖ Free</span>
                  <span>Full article available on publisher's site without signup</span>
                </div>
                <div class="source-info-item">
                  <span class="source-info-badge source-info-badge-limited">‚ö° Limited</span>
                  <span>Publisher offers limited free articles per month (e.g., 3-5/month)</span>
                </div>
                <div class="source-info-item">
                  <span class="source-info-badge source-info-badge-paid">üîí Paid</span>
                  <span>Publisher requires subscription to read full article</span>
                </div>
                <div class="source-info-note">üí° We generate posts from headlines & summaries only ‚Äî no paywall content is accessed.</div>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Search bar -->
        <div class="card mb-3">
          <form method="get" action="/news/{{ category.slug }}" class="search-form-centered">
            {% if current_source %}
            <input type="hidden" name="source" value="{{ current_source }}" />
            {% endif %}
            <input type="hidden" name="filter" value="{{ current_filter }}" />
            <div class="form-group mb-0 flex-1">
              <label class="form-label">üîç Search Articles</label>
              <input 
                type="text" 
                name="q" 
                value="{{ query }}" 
                class="form-input" 
                placeholder="Search by title or content..." 
              />
            </div>
            <button type="submit" class="btn search-btn">Search</button>
            {% if session.get('user_id') %}
            <button 
              hx-post="/api/news/refresh/{{ category.slug }}" 
              hx-swap="none"
              hx-on::after-request="if(event.detail.successful) location.reload()"
              type="button" 
              class="btn btn-secondary"
            >
              üîÑ Refresh
            </button>
            {% endif %}
          </form>
        </div>
    
    <!-- Articles list -->
    {% if articles %}
    <div class="article-grid">
      {% for a in articles %}
      <div class="article-card article-card-{{ a.source_type or 'free' }}">
        <div class="article-card-image {% if not a.image_url %}article-card-image-fallback{% endif %}">
          {% if a.image_url %}
          <img src="{{ a.image_url }}" alt="" loading="lazy" />
          {% else %}
          <div class="article-card-image-placeholder">
            <span class="placeholder-icon">üì∞</span>
          </div>
          {% endif %}
          {% if a.source_type == 'paid' %}
          <span class="source-overlay source-overlay-paid">üîí Paid</span>
          {% elif a.source_type == 'freemium' %}
          <span class="source-overlay source-overlay-freemium">‚ö° Freemium</span>
          {% endif %}
        </div>
        <div class="article-card-content">
          <!-- Source badge with type indicator -->
          {% if a.source_name %}
          <div class="article-source-badge article-source-badge-{{ a.source_type or 'free' }}">
            {{ a.source_name }}
            {% if a.source_type == 'freemium' %}<span class="ml-025">‚ö°</span>{% endif %}
            {% if a.source_type == 'paid' %}<span class="ml-025">üîí</span>{% endif %}
          </div>
          {% endif %}
          
          <h3 class="article-card-title">
            <a href="{{ a.url }}" target="_blank" rel="noopener">{{ a.title }}</a>
          </h3>
          
          <p class="article-card-summary">
            {{ a.summary|striptags|truncate(180, True, '...') }}
          </p>
          
          <div class="article-card-footer">
            <div class="article-card-meta">
              <span class="article-card-date">
                {{ a.created_at.strftime('%b %d, %Y') }}
              </span>
              {% if a.topics %}
              <div class="article-card-topics">
                {% for topic in (a.topics|dictsort|map(attribute=0)|list)[:2] %}
                <span class="article-topic-tag">{{ topic }}</span>
                {% endfor %}
              </div>
              {% endif %}
            </div>
            <a href="/generate?url={{ a.url|urlencode }}" class="btn btn-cta-enhanced btn-sm">
              ‚ú® Write Post About This
            </a>
          </div>
        </div>
      </div>
      {% endfor %}
    </div>
    
    <!-- Pagination -->
    {% if total_pages > 1 %}
    <div class="pagination mt-4">
      <div class="flex gap-05 justify-center items-center flex-wrap">
        {% if page > 1 %}
        <a href="/news/{{ category.slug }}?page={{ page - 1 }}&filter={{ current_filter }}{% if query %}&q={{ query|urlencode }}{% endif %}{% if current_source %}&source={{ current_source|urlencode }}{% endif %}" class="btn btn-secondary px-12 py-06">
          ‚Üê Previous
        </a>
        {% endif %}
        
        <span class="c-white-60 px-1">
          Page {{ page }} of {{ total_pages }}
        </span>
        
        {% if page < total_pages %}
        <a href="/news/{{ category.slug }}?page={{ page + 1 }}&filter={{ current_filter }}{% if query %}&q={{ query|urlencode }}{% endif %}{% if current_source %}&source={{ current_source|urlencode }}{% endif %}" class="btn btn-secondary px-12 py-06">
          Next ‚Üí
        </a>
        {% endif %}
      </div>
    </div>
    {% endif %}
    
    {% else %}
    <!-- Empty state -->
    <div class="card text-center py-6">
      <div class="fs-4rem mb-1rem">üì≠</div>
      <h3 class="c-white mb-1rem">No articles found</h3>
      <p class="c-white-80 mb-2">
        {% if query %}
        No articles match your search "{{ query }}". Try a different search term.
        {% elif current_source %}
        No articles from "{{ current_source }}" yet.
        {% elif current_filter == 'free' %}
        No free articles available. Try showing all news.
        {% else %}
        No articles have been fetched yet for this category.
        {% endif %}
      </p>
      {% if query or current_source or current_filter == 'free' %}
      <a href="/news/{{ category.slug }}" class="btn btn-secondary">Clear Filters</a>
      {% elif session.get('user_id') %}
      <button 
        hx-post="/api/news/refresh/{{ category.slug }}" 
        hx-swap="none"
        hx-on::after-request="if(event.detail.successful) location.reload()"
        class="btn btn-cta"
      >
        üîÑ Fetch Articles Now
      </button>
      {% endif %}
    </div>
    {% endif %}
      </div> <!-- End main-content -->
    </div> <!-- End content-with-sidebar -->
  </div> <!-- End section -->
</div>
{% endblock %}
