{% extends 'base_spaceship.html' %}
{% block content %}
<div class="container pt-6rem">
  <div class="section">
    <div class="text-center mb-6">
      <h1 class="fs-25rem fw-800 mb-1rem c-white">ğŸ“° Latest Articles</h1>
      <p class="fs-12rem c-white-80">Fresh content from top tech and business sources</p>
    </div>
    
    <div class="card mb-3rem">
      <form method="get" action="/news" class="flex gap-1 items-end flex-wrap">
        <div class="form-group flex-1 mb-0">
          <label class="form-label">ğŸ” Search Articles</label>
          <input type="text" name="q" value="{{ q }}" class="form-input" placeholder="Search by title or content..." />
        </div>
        <div class="form-group mb-0">
          <label class="form-label">ğŸ¯ Categories</label>
          <div class="flex gap-05 flex-wrap maxw-900">
            {% for c in categories or [] %}
              {% set active = c.slug in (selected_slugs or []) %}
              <label class="btn {% if active %}btn-cta{% else %}btn-secondary{% endif %} px-16 py-08 rounded-20 cursor-pointer">
                <input type="checkbox" name="categories" value="{{ c.slug }}" {% if active %}checked{% endif %} />
                {{ c.name }}
              </label>
            {% endfor %}
          </div>
        </div>
        <button type="submit" class="btn h-fit">Apply</button>
        {% if session.get('user_id') %}
        <button hx-post="/api/news/refresh" hx-swap="none" type="button" class="btn btn-secondary h-fit">
          ğŸ”„ Refresh Feed
        </button>
        {% endif %}
      </form>
    </div>
    
    {% if articles %}
    <div class="list">
      {% for a in articles %}
      <div class="list-item flex gap-1 items-start">
        {% if a.image_url %}
          <div class="w-140 h-100 overflow-hidden rounded-12 bg-card border-card">
            <img src="{{ a.image_url }}" alt="" class="img-cover" />
          </div>
        {% endif %}
        <div class="flex-1">
          <h3 class="mt-0">
            <a href="{{ a.url }}" target="_blank">{{ a.title }}</a>
          </h3>
          <div class="summary">{{ a.summary[:300] }}{% if a.summary|length > 300 %}...{% endif %}</div>
          <div class="mt-1rem flex justify-between items-center flex-wrap gap-1">
            <div class="c-white-60 fs-09rem">
              ğŸ“… {{ a.created_at.strftime('%B %d, %Y') }}
              {% if a.topics %}
              <span class="ml-05">
                ğŸ·ï¸ 
                {% for topic in (a.topics|dictsort|map(attribute=0)|list)[:3] %}
                  <span class="badge ml-05">{{ topic }}</span>
                {% endfor %}
              </span>
              {% endif %}
            </div>
            <a href="/generate?url={{ a.url|urlencode }}" class="btn p-05 fs-09rem">
              âœ¨ Generate Post
            </a>
          </div>
        </div>
      </div>
      {% endfor %}
    </div>
    {% else %}
    <div class="card text-center">
      <div class="fs-4rem mb-1rem">ğŸ“­</div>
      <h3 class="c-white mb-1rem">No articles found</h3>
      <p class="c-white-80 mb-2">
        {% if q %}
          Try a different search term or browse all articles.
        {% else %}
          No articles have been ingested yet. Refresh the feed to get started.
        {% endif %}
      </p>
      {% if session.get('user_id') %}
      <button hx-post="/api/news/refresh" hx-swap="none" class="btn btn-cta">
        ğŸ”„ Refresh Feed Now
      </button>
      {% endif %}
    </div>
    {% endif %}
    
    {% if articles and articles|length == 20 %}
    <div class="text-center mt-4">
      <a href="/news?page={{ (page or 1) + 1 }}{% if q %}&q={{ q }}{% endif %}{% for s in selected_slugs %}&categories={{ s }}{% endfor %}" class="btn btn-secondary">
        ğŸ“„ Load More Articles
      </a>
    </div>
    {% endif %}
  </div>
</div>
{% endblock %}
