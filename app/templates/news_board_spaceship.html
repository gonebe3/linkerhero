{% extends 'base_spaceship.html' %}
{% block content %}
<div class="container pt-6rem">
  <div class="section">
    <div class="text-center mb-6">
      <h1 class="fs-25rem fw-800 mb-1rem c-white">Content Fuel</h1>
      <p class="fs-12rem c-white-80">Browse fresh articles from your topics and turn any of them into a LinkedIn post in one click.</p>
    </div>

    {% if (selected_categories or []) %}
    <div class="news-topics-bar mb-3">
      <div class="news-topics-pills">
        {% for c in selected_categories %}
        <a
          href="/news?cat={{ c.slug }}"
          class="topic-pill {% if active_cat == c.slug %}topic-pill-active{% endif %}"
        >
          {{ c.name }}
        </a>
        {% endfor %}
        {% if active_cat %}
        <a href="/news" class="topic-clear">Clear</a>
        {% endif %}
      </div>
      <div class="news-topics-cta">
        <a href="/news/topics" class="btn btn-cta">Edit topics</a>
      </div>
    </div>
    {% else %}
    <div class="flex justify-center mb-3">
      <a href="/news/topics" class="btn btn-cta">Edit topics</a>
    </div>
    {% endif %}
    
    <div class="card mb-3rem">
      <form method="get" action="/news" class="flex gap-1 items-end flex-wrap">
        {% if active_cat %}
        <input type="hidden" name="cat" value="{{ active_cat }}" />
        {% endif %}
        {% if as_of %}
        <input type="hidden" name="as_of" value="{{ as_of }}" />
        {% endif %}
        <div class="form-group flex-1 mb-0">
          <label class="form-label">üîç Search Articles</label>
          <input type="text" name="q" value="{{ q }}" class="form-input" placeholder="Search by title or content..." />
        </div>
        <button type="submit" class="btn h-fit">Apply</button>
      </form>
    </div>
    
    {% if articles %}
    <div class="article-grid article-grid-3col">
      {% for a in articles %}
      <div class="article-card">
        <div class="article-card-image {% if not a.image_url %}article-card-image-fallback{% endif %}">
          {% if a.image_url %}
          <img src="{{ a.image_url }}" alt="" loading="lazy" />
          {% else %}
          <div class="article-card-image-placeholder">
            <span class="placeholder-icon">üì∞</span>
          </div>
          {% endif %}
        </div>
        <div class="article-card-actions">
          <a href="/generate?url={{ a.url|urlencode }}" class="btn p-05 fs-09rem w-100 text-center">
            ‚ú® Generate Post
          </a>
        </div>
        <div class="article-card-content">
          {% set cats = (article_categories_map or {}).get(a.id, []) %}
          {% if cats %}
          <div class="flex gap-05 flex-wrap mb-05">
            {% for c in cats[:3] %}
            <a href="/news?cat={{ c.slug }}" class="topic-pill topic-pill-sm {% if active_cat == c.slug %}topic-pill-active{% endif %}">
              {{ c.name }}
            </a>
            {% endfor %}
            {% if cats|length > 3 %}
            <span class="topic-pill topic-pill-sm" title="{{ cats|length }} categories">+{{ cats|length - 3 }}</span>
            {% endif %}
          </div>
          {% endif %}

          <h3 class="article-card-title">
            <a href="{{ a.url }}" target="_blank" rel="noopener">{{ a.title }}</a>
          </h3>

          <p class="article-card-summary">
            {{ a.summary|striptags|truncate(180, True, '...') }}
          </p>
          
          <div class="c-white-60 fs-085rem mt-05">
            {{ a.source_name or 'Unknown source' }}
          </div>

          <div class="article-card-footer">
            <div class="article-card-meta">
              <span class="article-card-date">{{ a.created_at.strftime('%b %d, %Y') }}</span>
              {% if a.topics %}
              <div class="article-card-topics">
                {% for topic in (a.topics|dictsort|map(attribute=0)|list)[:2] %}
                <span class="article-topic-tag">{{ topic }}</span>
                {% endfor %}
              </div>
              {% endif %}
            </div>
          </div>
        </div>
      </div>
      {% endfor %}
    </div>
    {% else %}
    <div class="card text-center">
      <div class="fs-4rem mb-1rem">üì≠</div>
      <h3 class="c-white mb-1rem">No articles found</h3>
      <p class="c-white-80 mb-2">
        {% if q %}
          Try a different search term or browse all articles.
        {% else %}
          No articles have been ingested yet.
        {% endif %}
      </p>
    </div>
    {% endif %}
    
    {% if total_pages and total_pages > 1 %}
    {% set p = page or 1 %}
    {% set start = (p - 3) if (p - 3) > 1 else 1 %}
    {% set end = (p + 3) if (p + 3) < total_pages else total_pages %}
    <div class="pagination mt-4">
      <div class="flex gap-05 justify-center items-center flex-wrap">
        {% if p > 1 %}
        <a href="/news?page={{ p - 1 }}{% if q %}&q={{ q }}{% endif %}{% if active_cat %}&cat={{ active_cat }}{% endif %}{% if as_of %}&as_of={{ as_of|urlencode }}{% endif %}" class="btn btn-secondary px-12 py-06">
          ‚Üê Previous
        </a>
        {% endif %}

        {% if start > 1 %}
        <a href="/news?page=1{% if q %}&q={{ q }}{% endif %}{% if active_cat %}&cat={{ active_cat }}{% endif %}{% if as_of %}&as_of={{ as_of|urlencode }}{% endif %}" class="btn btn-secondary px-12 py-06">1</a>
        {% if start > 2 %}
        <span class="c-white-60 px-1">‚Ä¶</span>
        {% endif %}
        {% endif %}

        {% for i in range(start, end + 1) %}
        {% if i == p %}
        <span class="btn px-12 py-06" style="pointer-events:none;opacity:0.95; border: 1px solid rgba(255,255,255,0.35);">{{ i }}</span>
        {% else %}
        <a href="/news?page={{ i }}{% if q %}&q={{ q }}{% endif %}{% if active_cat %}&cat={{ active_cat }}{% endif %}{% if as_of %}&as_of={{ as_of|urlencode }}{% endif %}" class="btn btn-secondary px-12 py-06">{{ i }}</a>
        {% endif %}
        {% endfor %}

        {% if end < total_pages %}
        {% if end < total_pages - 1 %}
        <span class="c-white-60 px-1">‚Ä¶</span>
        {% endif %}
        <a href="/news?page={{ total_pages }}{% if q %}&q={{ q }}{% endif %}{% if active_cat %}&cat={{ active_cat }}{% endif %}{% if as_of %}&as_of={{ as_of|urlencode }}{% endif %}" class="btn btn-secondary px-12 py-06">{{ total_pages }}</a>
        {% endif %}

        {% if p < total_pages %}
        <a href="/news?page={{ p + 1 }}{% if q %}&q={{ q }}{% endif %}{% if active_cat %}&cat={{ active_cat }}{% endif %}{% if as_of %}&as_of={{ as_of|urlencode }}{% endif %}" class="btn btn-secondary px-12 py-06">
          Next ‚Üí
        </a>
        {% endif %}
      </div>
    </div>
    {% endif %}
  </div>
</div>
{% endblock %}
