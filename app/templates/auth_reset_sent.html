{% extends 'base_spaceship.html' %}
{% block content %}
<div class="container pt-6rem">
  <div class="section maxw-520 mx-auto text-center">
    <div class="fs-4rem mb-6 anim-rocket-alt">ðŸ“§</div>
    <h1 class="fs-25rem fw-800 mb-1rem c-white">Check your inbox</h1>
    <div class="card">
      <p class="c-white-80 lh-16">
        If an account exists for that address, weâ€™ve sent a secure link to reset your password.
        The link expires in <strong>30 minutes</strong>.
      </p>
      <p class="c-white-80 lh-16 mt-05">
        Didnâ€™t receive the email? Check your spam folder or request a new link.
      </p>

      <form id="resend-form" class="mt-3" method="post" action="/forgot">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <input type="hidden" name="email" value="{{ email }}">
        <div id="resend-actions" class="flex gap-05 justify-center">
          <button id="resend-btn" type="submit" class="btn btn-secondary">Send another link</button>
          <a href="/login" class="btn btn-cta">Return to Login</a>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
(function(){
  var email = {{ (email or '')|tojson }};
  var serverRemain = {{ (remain or 0)|int }};
  var key = email ? ('reset_resend_next_' + email) : null;
  var btn = document.getElementById('resend-btn');
  var form = document.getElementById('resend-form');
  var defaultLabel = 'Send another link';

  function nowSec(){ return Math.floor(Date.now()/1000); }
  function setButtonCountdownText(remain){
    var m = Math.floor(remain/60);
    var s = remain%60;
    btn.textContent = 'You can request a new link in ' + m + 'm ' + (s<10?('0'+s):s) + 's';
  }
  function startCountdown(until){
    function tick(){
      var remain = until - nowSec();
      if (remain <= 0){
        btn.disabled = false;
        btn.classList.remove('btn-disabled');
        btn.textContent = defaultLabel;
        clearInterval(timer);
        return;
      }
      setButtonCountdownText(remain);
    }
    btn.disabled = true;
    btn.classList.add('btn-disabled');
    tick();
    var timer = setInterval(tick, 1000);
  }

  // Determine initial cooldown
  var next = 0;
  if (key){
    var localNext = parseInt(localStorage.getItem(key) || '0', 10);
    if (serverRemain && serverRemain > 0){
      next = nowSec() + serverRemain;
      // Sync local storage to server value so different entry points keep timer consistent
      localStorage.setItem(key, String(next));
    } else if (localNext > nowSec()) {
      next = localNext;
    }
  }

  if (next > nowSec()){
    startCountdown(next);
  } else {
    btn.textContent = defaultLabel;
  }

  form.addEventListener('submit', function(){
    // Visual cooldown; server enforces real limit
    var until = nowSec() + 300;
    if (key) localStorage.setItem(key, String(until));
    startCountdown(until);
  });
})();
</script>
{% endblock %}
